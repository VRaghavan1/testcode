
{
  "tasks": [
    {
      "taskCode": "RemoveDataCollection",
      "taskConfigurationTemplate": {
        "in": "",
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customerCode": "{CUSTOMER_CODE}",
          "dataRepositoryCode": "{DATA_REPOSITORY_CODE}",
          "dataCollectionCode": "tv-themepacks-record",
          "successIfNotExists": true
        }
      }
    },
    {
      "taskCode": "CreateDataCollection",
      "taskConfigurationTemplate": {
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customerCode": "{CUSTOMER_CODE}",
          "dataRepositoryCode": "{DATA_REPOSITORY_CODE}",
          "dataCollectionCode": "tv-themepacks-record",
          "dataRecordIdentifierProperty": "id"
        }
      }
    },
    {
      "taskCode": "DataRepositoryToDataRecordBulk",
      "taskConfigurationTemplate": {
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customer_code": "rogers",
          "datarepo_code": "eclipse-dev",
          "datarepo_collection_code": "tv-packages-themepacks-source"}
      }
    },
    {
    "taskClass": "FilterDataRecord",
    "taskCode": "FilterDataRecord-Type",
    "taskConfigurationTemplate": {
      "params": {
        "condition": {
          "$and": [
            {"TYPE": {"$eq": "Theme Pack"}}
          ]
        }
      }
    }
  },
  //   {
  //     "taskCode": "HydrateDataRecord-1",
  //     "taskClass": "HydrateDataRecord",
  //     "taskConfigurationTemplate": {
  //       "params": {
  //         "hydrate_configuration": [
  //           {
  //           "matchConfiguration": {
  //             "customerCode": "rogers",
  //             "dataRepositoryCode": "eclipse-dev",
  //             "dataCollectionCode": "pom-ptv-extract-source",
  //             "baseRecordLookupPropertyName": "PK_SOC",
  //             "lookupIdPropertyNames": ["PK_SOC.raw"],
  //             "uniqueRecords": true,
  //             "lookupFilter": [{
  //               "propertyName": "LANG.raw",
  //               "operation": "term",
  //               "value": "EN"
  //             },{
  //               "propertyName": "REGION.raw",
  //               "operation": "term",
  //               "value": "{{{REGION}}}"
  //             }]

  //           },
  //           "enrichConfiguration": {
  //             "channelList": [
  //               "$.matchingRecords[*][CHANNELID]"
  //               ]
  //           }
  //         },
  //           {
  //           "matchConfiguration": {
  //             "customerCode": "rogers",
  //             "dataRepositoryCode": "eclipse-dev",
  //             "dataCollectionCode": "channel-package-counts-source",
  //             "baseRecordLookupPropertyName": "PK_SOC",
  //             "lookupIdPropertyNames": ["pk_soc.raw"],
  //             "uniqueRecords": true,
  //             "lookupFilter": [{
  //               "propertyName": "province.raw",
  //               "operation": "term",
  //               "value": "{{{REGION}}}"
  //             }]

  //           },
  //           "enrichConfiguration": {
  //             "ute~sku~package~totalChannelCount": 
  //               "$.matchingRecords[*].totalChannelCount"
  //             ,
  //             "ute~sku~package~progChnlList": [
  //               "$.matchingRecords[*].progChnlList"
  //               ],
  //             "ute~sku~package~premiumChannelFlag": [
  //               "$.matchingRecords[*].premiumChannelFlag"
  //               ],
  //             "ute~sku~package~premiumChannelList": [
  //               "$.matchingRecords[*].premiumChannelList_pkg"
  //               ]
  //           }
  //         }

  //           ]
  //       }
  //     }
  //   }
  //  ,
  //   {
  //     "taskCode": "HydrateDataRecord-2",
  //     "taskClass": "HydrateDataRecord",
  //     "taskConfigurationTemplate": {
  //       "params": {
  //         "hydrate_configuration": [
  //           {
  //           "matchConfiguration": {
  //             "customerCode": "rogers",
  //             "dataRepositoryCode": "eclipse-dev",
  //             "dataCollectionCode": "teamsite-channel-content-source",
  //             "baseRecordLookupPropertyName": "channelList",
  //             "lookupIdPropertyNames": ["english.product_info.product_ID.raw"],
  //             "uniqueRecords": true,
  //             "lookupFilter": [{
  //               "propertyName": "english.product_type.raw",
  //               "operation": "term",
  //               "value": "PTV_CHANNEL"
  //             }]
  //           },
  //           "enrichConfiguration": {
  //             "ute.sku.package.channels.en": [
  //               "$.matchingRecords",
  //               {
  //                 "ute~name~en": "english.product_info.product_title",
  //                 "ute~description~en": "english.product_info.short_desc",
  //                 "ute~image~1": "english.product_images1.image_from_teamsite",
  //                 "ute~image~2": "english.product_images2.image_from_teamsite",
  //                 "ute~image~3": "english.product_images3.image_from_teamsite"
  //               }
  //             ],
  //             "ute.sku.package.channels.names.en": ["$.matchingRecords[*].english.product_info.product_title"]
  //           }
  //         },
  //         {
  //           "matchConfiguration": {
  //             "customerCode": "rogers",
  //             "dataRepositoryCode": "eclipse-dev",
  //             "dataCollectionCode": "teamsite-channel-content-source",
  //             "baseRecordLookupPropertyName": "channelList",
  //             "lookupIdPropertyNames": ["french.product_info.product_ID.raw"],
  //             "uniqueRecords": true,
  //             "lookupFilter": [{
  //               "propertyName": "french.product_type.raw",
  //               "operation": "term",
  //               "value": "PTV_CHANNEL"
  //             }]
  //           },
  //           "enrichConfiguration": {
  //             "ute.sku.package.channels.fr": [
  //               "$.matchingRecords",
  //               {
  //                 "ute~name~fr": "french.product_info.product_title",
  //                 "ute~description~fr": "french.product_info.short_desc",
  //                 "ute~image~1": "french.product_images1.image_from_teamsite",
  //                 "ute~image~2": "french.product_images2.image_from_teamsite",
  //                 "ute~image~3": "french.product_images3.image_from_teamsite"
  //               }
  //             ],
  //             "ute.sku.package.channels.names.fr": ["$.matchingRecords[*].french.product_info.product_title"]
  //           }
  //         },
  //           {
  //           "matchConfiguration": {
  //             "customerCode": "rogers",
  //             "dataRepositoryCode": "eclipse-dev",
  //             "dataCollectionCode": "teamsite-channel-content-source",
  //             "baseRecordLookupPropertyName": "PK_SOC",
  //             "lookupIdPropertyNames": ["english.product_info.product_ID.raw"],
  //             "uniqueRecords": true,
  //             "lookupFilter": [{
  //               "propertyName": "english.product_type.raw",
  //               "operation": "term",
  //               "value": "PTV_PACKAGE"
  //             }]
  //           },
  //           "enrichConfiguration": {
  //             "ute.name.en": "$.matchingRecords[*].english.product_info.product_title",
  //             "ute.description.en": "$.matchingRecords[*].english.product_info.short_desc",
  //             "ute.sku.package.image.1.en": "$.matchingRecords[*].english.product_images1.image_from_teamsite",
  //             "ute.sku.package.image.2.en": "$.matchingRecords[*].english.product_images2.image_from_teamsite",
  //             "ute.sku.package.image.3.en": "$.matchingRecords[*].english.product_images3.image_from_teamsite"
  //           }
  //         },
  //           {
  //           "matchConfiguration": {
  //             "customerCode": "rogers",
  //             "dataRepositoryCode": "eclipse-dev",
  //             "dataCollectionCode": "teamsite-channel-content-source",
  //             "baseRecordLookupPropertyName": "PK_SOC",
  //             "lookupIdPropertyNames": ["french.product_info.product_ID.raw"],
  //             "uniqueRecords": true,
  //             "lookupFilter": [{
  //               "propertyName": "french.product_type.raw",
  //               "operation": "term",
  //               "value": "PTV_PACKAGE"
  //             }]
  //           },
  //           "enrichConfiguration": {
  //             "ute.name.fr": "$.matchingRecords[*].french.product_info.product_title",
  //             "ute.description.fr": "$.matchingRecords[*].french.product_info.short_desc",
  //             "ute.sku.package.image.1.fr": "$.matchingRecords[*].french.product_images1.image_from_teamsite",
  //             "ute.sku.package.image.2.fr": "$.matchingRecords[*].french.product_images2.image_from_teamsite",
  //             "ute.sku.package.image.3.fr": "$.matchingRecords[*].french.product_images3.image_from_teamsite"
  //           }
  //         },
  //           {
  //           "matchConfiguration": {
  //             "customerCode": "rogers",
  //             "dataRepositoryCode": "eclipse-dev",
  //             "dataCollectionCode": "ptv-package-source",
  //             "baseRecordLookupPropertyName": "PK_SOC",
  //             "lookupIdPropertyNames": ["SOC.raw"],
  //             "uniqueRecords": true
  //           },
  //           "enrichConfiguration": {
  //             "ute.sku.package.price": "$.matchingRecords[*].MSF"
  //           }
  //         }
  //       ]
  //     }
  //   }
  // },
  {
      "taskCode": "CreateTombstoneProperties",
      "taskClass": "CreateProperties",
      "taskConfigurationTemplate": {
        "params": {
          "propertyNames": [
            "ute~recordType",
            "ute~recordClass",
            "ute~sourceSystem",
            "ute~lineOfBusiness",
            "ute~language",
            "ute~site"
          ],
          "propertyValues": [
            "sku",
            "themePack",
            ["clicc"],
            "iptv",
            ["EN", "FR"],
            "rogers"
          ]
        }
      }
    },
  {
      "taskCode": "CopyProperties-1",
      "taskClass": "CopyProperties",
      "taskConfigurationTemplate": {
        "params": {
          "copyProperties": [
            {"source":"POM_SOC", "target":"ute~id"},
            {"source":"NAME_EN", "target":"ute~name~en"},
            {"source":"NAME_FR", "target":"ute~name~fr"},
            {"source":"DESCRIPTION_SHORT_EN", "target":"ute~description~en"},
            {"source":"DESCRIPTION_SHORT_FR", "target":"ute~description~fr"},
            {"source":"DESCRIPTION_LONG_EN", "target":"ute~description~long~en"},
            {"source":"DESCRIPTION_LONG_FR", "target":"ute~description~long~fr"},
            {"source":"GENRE_1_EN", "target":"ute~sku~themepack~genre~en"},
            {"source":"SUBGENRE_1_EN", "target":"ute~sku~themepack~subgenre~en"},
            {"source":"TAGS_EN", "target":"ute~sku~themepack~tags~en"},
            {"source":"ORDINAL", "target":"ute~sku~themepack~ordinal"},
            {"source":"OBJECT_TYPE", "target":"ute~sku~themepack~type"}
          ]
        }
      }
    },



    {
      "taskCode": "DimensionLookups",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-endeca-dimensions-source",
              "baseRecordLookupPropertyName": "ute~sku~themepack~genre~en",
              "lookupIdPropertyNames": ["dimval~spec.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "dimval~dimension_name.raw",
                "operation": "term",
                "value": "ute.sku.themepack.genre.en"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~themepack~genre~fr": "$.matchingRecords[*].displayName~fr"
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-endeca-dimensions-source",
              "baseRecordLookupPropertyName": "ute~sku~themepack~subgenre~en",
              "lookupIdPropertyNames": ["dimval~spec.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "dimval~dimension_name.raw",
                "operation": "term",
                "value": "ute.sku.themepack.subgenre.en"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~themepack~subgenre~fr": "$.matchingRecords[*].displayName~fr"
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-endeca-dimensions-source",
              "baseRecordLookupPropertyName": "ute~sku~themepack~tags~en",
              "lookupIdPropertyNames": ["dimval~spec.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "dimval~dimension_name.raw",
                "operation": "term",
                "value": "ute.sku.themepack.tags.en"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~themepack~tags~fr": "$.matchingRecords[*].displayName~fr"
            }
          }
            ]
        }
      }
    },




    {
      "taskCode": "ExpandbySystem-1",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "unique-clicc-systems",
              "uniqueRecords": true
            },
            "enrichConfiguration": {
              "systemId": [
                "$.matchingRecords[*][SYSTEM_TAB_NUM]"
              ]
            }
          }
          ]
        }
      }
    },
    {
      "taskClass": "NormalizeDataRecord",
      "taskCode": "NormalizeDataRecord-System",
      "taskConfigurationTemplate": {
        "params": {
          "property": ["systemId"]
        }
      }
    },

    {
      "taskCode": "Pricing",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-pom-pricing-source",
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "POM_SOC_CODE.raw",
                "operation": "term",
                "value": "{{{POM_SOC}}}"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~themepack~price": 
                "$.matchingRecords[*].PRICE"
            }
          }
          ]
        }
      }
    },

    {
      "taskCode": "GetChannels2",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-product-code-to-soc-source",
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "POM_SOC.raw",
                "operation": "term",
                "value": "{{{POM_SOC}}}"
              }, {
                "propertyName": "SYSTEM_TABNUM.raw",
                "operation": "term",
                "value": "{{{systemId}}}"
              }]
              ,
              "hydrateConfiguration": [
              {
              "matchConfiguration": {
                "customerCode": "rogers",
                "dataRepositoryCode": "eclipse-dev",
                "dataCollectionCode": "tv-clicc-channels-source",
                "uniqueRecords": true,
                "lookupFilter": [{
//                  "propertyName": "PRODUCT_CODE.raw",
                  "propertyName": "COMPONENT_ID.raw",
                  "operation": "term",
                  "value": "{{{POM_SOC}}}"
                }, {
                  "propertyName": "SYSTEM_TAB_NUM.raw",
                  "operation": "term",
                  "value": "{{{SYSTEM_TABNUM}}}"
                }]
              },
              "enrichConfiguration": {
                "EXTERNAL_NAME_EN": ["$.matchingRecords[*].EXTERNAL_NAME_EN"],
                "EXTERNAL_NAME_FR": ["$.matchingRecords[*].EXTERNAL_NAME_FR"],
                "SERVICE_ID": ["$.matchingRecords[*].SERVICE_ID"],
                "ute~sku~themepack~channels": [
                  "$.matchingRecords",
                  {
                    "ute~channel~id": "SERVICE_ID",
                    "ute~name~en": "EXTERNAL_NAME_EN",
                    "ute~name~fr": "EXTERNAL_NAME_FR",
                    "ute~description~en": "CHANNEL_DESCRIPTION_EN",
                    "ute~description~fr": "CHANNEL_DESCRIPTION_FR",
                    "ute~image": "CHANNEL_LOGO",
                    "ute~sku~channel~websiteURL": "WEBSITE_URL"
                  }
                ]
              }
            }
            ]
            },
            "enrichConfiguration": {
              "ute~sku~themepack~channels~names~en": ["$.matchingRecords[*].EXTERNAL_NAME_EN[*]"],
              "ute~sku~themepack~channels~names~fr": ["$.matchingRecords[*].EXTERNAL_NAME_FR[*]"],
              "ute~sku~themepack~channels~id": ["$.matchingRecords[*].SERVICE_ID[*]"],
              "ute~sku~themepack~totalChannelCount": "$.matchingRecords[*].CHANNEL_COUNT",
              "ute~sku~themepack~channels~en": ["$.matchingRecords[*].ute~sku~themepack~channels[*]"],
              "ute~sku~themepack~channels~fr": ["$.matchingRecords[*].ute~sku~themepack~channels[*]"]
            }
          }
          ]
        }
      }
    },
  //    {
  //    "taskClass": "FilterDataRecord",
  //    "taskCode": "RemoveRecordWithNoChannel",
  //    "taskConfigurationTemplate": {
  //      "params": {
  //        "condition": {
  //          "$not": 
  //             {"ute~sku~themepack~channels~id": {"$size": 0} }
  //        }
  //      }
  //    }
  //  },


    {
     "taskCode": "GetId",
     "taskClass": "RunScriptComponent",
     "taskConfigurationTemplate": {
       "params": {
         "script":
         "dataRecord['id'] = _.uniqueId(dataRecord['id']);"
       }
     }
   },
    {
     "taskCode": "GetInternalID",
     "taskClass": "RunScriptComponent",
     "taskConfigurationTemplate": {
       "params": {
         "script":
         "dataRecord['ute~internal~id'] =  dataRecord['id']"
       }
     }
   },
  {
      "taskCode": "CopyProperties-2",
      "taskClass": "CopyProperties",
      "taskConfigurationTemplate": {
        "params": {
          "copyProperties": [
            {"source":"systemId", "target":"ute~sku~channel~channelLineup"}
          ]
        }
      }
    },
    {
      "taskClass": "KeepUniqueValues",
      "taskCode": "KeepUniqueValues",
      "taskConfigurationTemplate": {
        "params": {
          "property": ["ute~*", "ute.*"]
        }
      }
    },
    {
      "taskCode": "PickProperties",
      "taskConfigurationTemplate": {
        "params": {
          "properties": ["ute~*", "ute.*"]
        }
      }
    },
    {
     "taskCode": "ReplacePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "pattern": ".",
          "replacement": "~",
          "property": "*"
        }
      }
    },
     {
     "taskCode": "Debug",
     "taskConfigurationTemplate": {
       "params": {}
     }
   },
    {
      "taskCode": "DataRecordToDataRepositoryBulk",
      "taskConfigurationTemplate": {
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customerCode": "{CUSTOMER_CODE}",
          "dataRepositoryCode": "{DATA_REPOSITORY_CODE}",
          "dataCollectionCode": "tv-themepacks-record"
        }
      }
    }
  ]
}