
{
  "tasks": [
    {
      "taskCode": "CreateDataCollection-digital-package-records",
      "taskClass": "CreateDataCollection",
      "taskConfigurationTemplate": {
        "in": {"properties": [
            "PK_SOC.raw",
            "REGION.raw"]},
        "params": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "digital-package-records",
          "dataRecordIdentifierProperty": "id",
          "name": "Digital Package Records",
          "successIfExists": true
        }
      }
    }
    ,
    {
      "taskCode": "TruncateDataCollection-digital-package-records",
      "taskClass": "TruncateDataCollection",
      "taskConfigurationTemplate": {
        "params": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "digital-package-records"
        }
      }
    },
    {
      "taskCode": "UniqueDataRecordPropertiesToDataRecord",
      "taskConfigurationTemplate": {
        "params": {
            "datareposervice_host": "localhost",
            "datareposervice_port": "40380",
            "customer_code": "rogers",
              "datarepo_code": "eclipse-dev",
              "datarepo_collection_code": "pom-ptv-extract-source"
        }
      }
    }
   ,
    {
      "taskCode": "HydrateDataRecord-1",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "pom-ptv-extract-source",
              "baseRecordLookupPropertyName": "PK_SOC",
              "lookupIdPropertyNames": ["PK_SOC.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "LANG.raw",
                "operation": "term",
                "value": "EN"
              },{
                "propertyName": "REGION.raw",
                "operation": "term",
                "value": "{{{REGION}}}"
              }]

            },
            "enrichConfiguration": {
              "channelList": [
                "$.matchingRecords[*][CHANNELID]"
                ]
            }
          },
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "channel-package-counts-source",
              "baseRecordLookupPropertyName": "PK_SOC",
              "lookupIdPropertyNames": ["pk_soc.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "province.raw",
                "operation": "term",
                "value": "{{{REGION}}}"
              }]

            },
            "enrichConfiguration": {
              "ute~sku~package~totalChannelCount": 
                "$.matchingRecords[*].totalChannelCount"
              ,
              "ute~sku~package~progChnlList": [
                "$.matchingRecords[*].progChnlList"
                ],
              "ute~sku~package~premiumChannelFlag": [
                "$.matchingRecords[*].premiumChannelFlag"
                ],
              "ute~sku~package~premiumChannelList": [
                "$.matchingRecords[*].premiumChannelList_pkg"
                ]
            }
          }

            ]
        }
      }
    }
   ,
    {
      "taskCode": "HydrateDataRecord-2",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "teamsite-channel-content-source",
              "baseRecordLookupPropertyName": "channelList",
              "lookupIdPropertyNames": ["english.product_info.product_ID.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "english.product_type.raw",
                "operation": "term",
                "value": "PTV_CHANNEL"
              }]
            },
            "enrichConfiguration": {
              "ute.sku.package.channels.en": [
                "$.matchingRecords",
                {
                  "ute~name~en": "english.product_info.product_title",
                  "ute~description~en": "english.product_info.short_desc",
                  "ute~image~1": "english.product_images1.image_from_teamsite",
                  "ute~image~2": "english.product_images2.image_from_teamsite",
                  "ute~image~3": "english.product_images3.image_from_teamsite"
                }
              ],
              "ute.sku.package.channels.names.en": ["$.matchingRecords[*].english.product_info.product_title"]
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "teamsite-channel-content-source",
              "baseRecordLookupPropertyName": "channelList",
              "lookupIdPropertyNames": ["french.product_info.product_ID.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "french.product_type.raw",
                "operation": "term",
                "value": "PTV_CHANNEL"
              }]
            },
            "enrichConfiguration": {
              "ute.sku.package.channels.fr": [
                "$.matchingRecords",
                {
                  "ute~name~fr": "french.product_info.product_title",
                  "ute~description~fr": "french.product_info.short_desc",
                  "ute~image~1": "french.product_images1.image_from_teamsite",
                  "ute~image~2": "french.product_images2.image_from_teamsite",
                  "ute~image~3": "french.product_images3.image_from_teamsite"
                }
              ],
              "ute.sku.package.channels.names.fr": ["$.matchingRecords[*].french.product_info.product_title"]
            }
          },
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "teamsite-channel-content-source",
              "baseRecordLookupPropertyName": "PK_SOC",
              "lookupIdPropertyNames": ["english.product_info.product_ID.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "english.product_type.raw",
                "operation": "term",
                "value": "PTV_PACKAGE"
              }]
            },
            "enrichConfiguration": {
              "ute.name.en": "$.matchingRecords[*].english.product_info.product_title",
              "ute.description.en": "$.matchingRecords[*].english.product_info.short_desc",
              "ute.sku.package.image.1.en": "$.matchingRecords[*].english.product_images1.image_from_teamsite",
              "ute.sku.package.image.2.en": "$.matchingRecords[*].english.product_images2.image_from_teamsite",
              "ute.sku.package.image.3.en": "$.matchingRecords[*].english.product_images3.image_from_teamsite"
            }
          },
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "teamsite-channel-content-source",
              "baseRecordLookupPropertyName": "PK_SOC",
              "lookupIdPropertyNames": ["french.product_info.product_ID.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "french.product_type.raw",
                "operation": "term",
                "value": "PTV_PACKAGE"
              }]
            },
            "enrichConfiguration": {
              "ute.name.fr": "$.matchingRecords[*].french.product_info.product_title",
              "ute.description.fr": "$.matchingRecords[*].french.product_info.short_desc",
              "ute.sku.package.image.1.fr": "$.matchingRecords[*].french.product_images1.image_from_teamsite",
              "ute.sku.package.image.2.fr": "$.matchingRecords[*].french.product_images2.image_from_teamsite",
              "ute.sku.package.image.3.fr": "$.matchingRecords[*].french.product_images3.image_from_teamsite"
            }
          },
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "ptv-package-source",
              "baseRecordLookupPropertyName": "PK_SOC",
              "lookupIdPropertyNames": ["SOC.raw"],
              "uniqueRecords": true
            },
            "enrichConfiguration": {
              "ute.sku.package.price": "$.matchingRecords[*].MSF"
            }
          }
        ]
      }
    }
  },
  {
      "taskCode": "CreateTombstoneProperties",
      "taskClass": "CreateProperties",
      "taskConfigurationTemplate": {
        "params": {
          "propertyNames": [
            "ute~recordType",
            "ute~recordClass",
            "ute~sourceSystem",
            "ute~lineOfBusiness",
            "ute~language",
            "ute~site"
          ],
          "propertyValues": [
            "sku",
            "package",
            ["teamsite", "pom"],
            "digitalCable",
            ["EN", "FR"],
            "rogers"
          ]
        }
      }
    },
    {
      "taskCode": "UpdateTombstoneProperties",
      "taskClass": "ChangePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "replacePropertyNames": [
            {"source":"PK_SOC", "target":"ute~id"},
            {"source":"REGION", "target":"ute~province"}
          ]
        }
      }
    },
    {
     "taskCode": "runScriptCreatePackageRecord",
     "taskClass": "RunScriptComponent",
     "taskConfigurationTemplate": {
       "params": {
         "script":
         "dataRecord['ute~internal~id'] =  _.snakeCase(dataRecord['ute~recordType'] + '-' + dataRecord['ute~recordClass'] + '-' + dataRecord['ute~lineOfBusiness'] + '-' + dataRecord['ute~id'] + '-' + dataRecord['ute~province'])"
       }
     }
   },
    {
     "taskCode": "ReplacePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "pattern": ".",
          "replacement": "~",
          "property": "*"
        }
      }
    }
    ,
//    {
//      "taskCode": "Debug",
//      "taskConfigurationTemplate": {
//        "params": {}
//      }
//    },
    {
      "taskCode": "DataRecordToDataRepositoryBulk",
      "taskConfigurationTemplate": {
        "params": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "digital-package-records"
        }
      }
    }
  ]
}