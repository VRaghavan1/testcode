{
  "tasks": [
    {
      "taskCode": "CreateDataCollection",
      "taskConfigurationTemplate": {
        "in": {"properties": [
              "ute~seo~pageTitle~en.raw"
            ]},
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customerCode": "{CUSTOMER_CODE}",
          "dataRepositoryCode": "{DATA_REPOSITORY_CODE}",
          "dataCollectionCode": "teamsite-aggregate-content-record",
          "dataRecordIdentifierProperty": "id",
          "successIfExists": true
        }
      }
    },
    {
      "taskCode": "TruncateDataCollection",
      "taskConfigurationTemplate": {
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customerCode": "{CUSTOMER_CODE}",
          "dataRepositoryCode": "{DATA_REPOSITORY_CODE}",
          "dataCollectionCode": "teamsite-aggregate-content-record"
        }
      }
    },
    {
      "taskCode": "UniqueDataRecordPropertiesToDataRecord",
      "taskConfigurationTemplate": {
        "params": {
            "datareposervice_host": "localhost",
            "datareposervice_port": "40380",
            "customer_code": "rogers",
            "datarepo_code": "eclipse-dev",
            "datarepo_collection_code": "teamsite-new-content-record"
        }
      }
    },
    {
      "taskCode": "CreateTombstoneProperties",
      "taskClass": "CreateProperties",
      "taskConfigurationTemplate": {
        "params": {
          "propertyNames": [
            "ute~recordType",
            "ute~recordClass",
            "ute~sourceSystem",
            "ute~lineOfBusiness",
            "ute~language",
            "ute~site",
            "ute~content~support~isParent",
            "ute~content~support~recordFormat"
          ],
          "propertyValues": [
            "content",
            "support",
            "teamsite",
            "wireless",
            ["EN","FR"],
            "rogers",
            "true",
            "new"
          ]
        }
      }
    },

    {
      "taskCode": "HandleParent",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [

            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "teamsite-new-content-record",
              "baseRecordLookupPropertyName": "ute~seo~pageTitle~en",
              "lookupIdPropertyNames": ["ute~seo~pageTitle~en.raw"],
              "lookupFilter": {
                "propertyName": "ute~content~support~page_type.raw",
                "operation": "term",
                "value": "Y"
              }
            },
            "enrichConfiguration": {
                "ute~name~en": "$.matchingRecords[*].ute~name~en",
                "ute~name~fr": "$.matchingRecords[*].ute~name~fr",
                "ute~description~en": "$.matchingRecords[*].ute~description~en",
                "ute~description~fr": "$.matchingRecords[*].ute~description~fr",
                "ute~content~support~content_id": "$.matchingRecords[*].ute~content~support~content_id",

                "ute~seo~seo_title~en": "$.matchingRecords[*].ute~seo~seo_title~en",
                "ute~seo~seo_desc~en": "$.matchingRecords[*].ute~seo~seo_desc~en",
                "ute~seo~seo_title~fr": "$.matchingRecords[*].ute~seo~seo_title~fr",
                "ute~seo~seo_desc~fr": "$.matchingRecords[*].ute~seo~seo_desc~fr",

                "ute~seo~keywords~en": [
                    "$.matchingRecords[*].ute~seo~keywords~en"
                ],
                "ute~seo~keywords~fr": [
                    "$.matchingRecords[*].ute~seo~keywords~fr"
                ],
                "ute~content~searchableContent~en": [
                  "$.matchingRecords[*].ute~description~en"
                ],
                "ute~content~searchableContent~fr": [
                  "$.matchingRecords[*].ute~description~fr"
                ],

                "ute~content~support~article_ctgy~en": "$.matchingRecords[*].ute~content~support~article_ctgy~en",
                "ute~content~support~article_ctgy~fr": "$.matchingRecords[*].ute~content~support~article_ctgy~fr",
                "ute~content~support~typeahead~en": "$.matchingRecords[*].ute~content~support~typeahead~en",
                "ute~content~support~typeahead~fr": "$.matchingRecords[*].ute~content~support~typeahead~fr",

                "ute~content~support~content~serialized~en": "$.matchingRecords[*].ute~content~support~content~serialized~en",
                "ute~content~support~content~serialized~fr": "$.matchingRecords[*].ute~content~support~content~serialized~fr",
                "ute~province": "$.matchingRecords[*].ute~province",
                "ute~content~support~contentType~en": "$.matchingRecords[*].ute~content~support~contentType~en",
                "ute~content~support~contentType~fr": "$.matchingRecords[*].ute~content~support~contentType~fr",
                "ute~seo~pageTitle~fr": "$.matchingRecords[*].ute~seo~pageTitle~fr",
                "hasParentArticle": ["$.matchingRecords[*].ute~seo~pageTitle~en"]
            }
          }
        ]
      }
      }
    },
    {
     "taskCode": "runscriptHasParent",
     "taskClass": "RunScriptComponent",
     "taskConfigurationTemplate": {
       "params": {
         "script":
         "dataRecord['hasParentArticle'] = dataRecord['hasParentArticle'].length > 0;"
       }
     }
   },
   
   {
      "taskCode": "Gather-modified-dates-of-children",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "condition": { "hasParentArticle": { "$eq": true} },
          "hydrate_configuration": [
            {
              "matchConfiguration": {
                "customerCode": "rogers",
                "dataRepositoryCode": "eclipse-dev",
                "dataCollectionCode": "teamsite-new-content-record",
                "baseRecordLookupPropertyName": "ute~seo~pageTitle~en",
                "lookupIdPropertyNames": ["ute~seo~pageTitle~en.raw"]
              },
              "enrichConfiguration": {
                "ute~content~support~date_modified_hidden_of_children": [
                  "$.matchingRecords[*].ute~content~support~date_modified_hidden"
                ]
              }
            }
          ]
        }
      }
    },

    {
      "description": "Only keep records that are designated as a parent (page_type=Y) or that are a part of a group of 2 or more. Single articles do not need parents.",
      "taskClass": "FilterDataRecord",
      "taskCode": "FilterDataRecord-ChildCount",
      "taskConfigurationTemplate": {
        "params": {
          "condition": {
            "hasParentArticle": {"$eq": true}
          }
        }
      }
    },

    {
     "taskCode": "RunScriptComponent-100",
     "taskClass": "RunScriptComponent",
     "taskConfigurationTemplate": {
       "params": {
         "script":
         "dataRecord['ute~content~support~seoUrl'] = !_.isEmpty(dataRecord['ute~content~support~content_id']) ? dataRecord['ute~content~support~content_id'] : _.kebabCase(dataRecord['ute~seo~pageTitle~en']);"
       }
     }
   },

    {
      "taskCode": "KeepUniqueValues",
      "taskConfigurationTemplate": {
        "params": {
          "property": [
            "ute~seo~keywords~en",
            "ute~seo~keywords~fr",
            "ute~content~searchableContent~en",
            "ute~content~searchableContent~fr"
          ]
        }
      }
    },


    {
      "taskCode": "CopyProperties",
      "taskConfigurationTemplate": {
        "params": {
          "copyProperties": [
            {"source":"ute~content~support~display_from_date_hidden", "target":"ute~dateActive", "default": "647460275"},
            {"source":"ute~content~support~display_to_date_hidden", "target":"ute~dateInactive", "default": "7274426675"}
          ]
        }
      }
    },

    {
      "taskCode": "ReplacePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "pattern": "ute~content~support~is_active",
          "replacement": "ute~is_active",
          "property": "ute~content~support~is_active"
        }
      }
    },

    {
      "taskCode": "Choose-latest-updated-date",
      "taskClass": "RunScriptComponent",
      "taskConfigurationTemplate": {
        "params": {
          "script":
            "dataRecord['ute~content~support~date_modified_hidden'] = _.max(dataRecord['ute~content~support~date_modified_hidden_of_children']);"
        }
      }
    },

    {
      "taskCode": "Set-internal-id",
      "taskClass": "RunScriptComponent",
      "taskConfigurationTemplate": {
        "params": {
          "script":
          "dataRecord['ute~internal~id'] = dataRecord['ute~content~support~date_created_hidden'] ? (_.snakeCase(dataRecord['ute~content~support~content_id']) + '-' + dataRecord['ute~content~support~date_created_hidden']) : dataRecord['ute~internal~id'];"
        }
      }   
    },

    {
      "taskCode": "PickProperties",
      "taskConfigurationTemplate": {
        "params": {
          "properties": ["ute~*"]
        }
      }
    },
    {
      "taskCode": "DataRecordToDataRepositoryBulk",
      "taskConfigurationTemplate": {
        "params": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "teamsite-aggregate-content-record"
        }
      }
    }

  ]
}