{
  "description": "Creates legacy parent article records",
  "tasks": [
    {
      "taskCode": "CreateDataCollection",
      "taskConfigurationTemplate": {
        "in": {"properties": [
              "ute~seo~pageTitle~en.raw"
            ]},
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customerCode": "{CUSTOMER_CODE}",
          "dataRepositoryCode": "{DATA_REPOSITORY_CODE}",
          "dataCollectionCode": "teamsite-aggregate-legacy-content-record",
          "dataRecordIdentifierProperty": "id",
          "successIfExists": true
        }
      }
    },
    {
      "taskCode": "TruncateDataCollection",
      "taskConfigurationTemplate": {
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customerCode": "{CUSTOMER_CODE}",
          "dataRepositoryCode": "{DATA_REPOSITORY_CODE}",
          "dataCollectionCode": "teamsite-aggregate-legacy-content-record"
        }
      }
    },
    {
      "taskCode": "UniqueDataRecordPropertiesToDataRecord",
      "taskConfigurationTemplate": {
        "params": {
            "datareposervice_host": "localhost",
            "datareposervice_port": "40380",
            "customer_code": "rogers",
              "datarepo_code": "eclipse-dev",
              "datarepo_collection_code": "teamsite-legacy-content-record"
        }
      }
    },
    {
      "taskCode": "CreateTombstoneProperties",
      "taskClass": "CreateProperties",
      "taskConfigurationTemplate": {
        "params": {
          "propertyNames": [
            "ute~recordType",
            "ute~recordClass",
            "ute~sourceSystem",
            "ute~lineOfBusiness",
            "ute~language",
            "ute~site",
            "ute~content~support~recordFormat",
            "ute~content~support~isParent"
          ],
          "propertyValues": [
            "content",
            "support",
            "teamsite",
            "wireless",
            ["EN","FR"],
            "rogers",
            "legacy",
            "true"
          ]
        }
      }
    },

    {
       "taskCode": "GetUniqueInternalId",
       "taskClass": "RunScriptComponent",
       "taskConfigurationTemplate": {
         "params": {
           "script":
           "dataRecord['ute~internal~id'] = _.uniqueId('parent_support_legacy_article_');"
         }
       }
    },

    {
      "taskCode": "HandleChildren",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "teamsite-legacy-content-record",
              "baseRecordLookupPropertyName": "ute~seo~pageTitle~en",
              "lookupIdPropertyNames": ["ute~seo~pageTitle~en.raw"]
            },
            "enrichConfiguration": {
                "childCount": [
                  "$.matchingRecords[*].ute~seo~pageTitle~en"
                ],
                "ute~name~en": "$.matchingRecords[*].ute~name~en",
                "ute~name~fr": "$.matchingRecords[*].ute~name~fr",
                "ute~description~en": "$.matchingRecords[*].ute~description~en",
                "ute~description~fr": "$.matchingRecords[*].ute~description~fr",
                "ute~seo~keywords~en": [
                    "$.matchingRecords[*].ute~seo~keywords~en"
                ],
                "ute~seo~keywords~fr": [
                    "$.matchingRecords[*].ute~seo~keywords~fr"
                ],
                "ute~content~searchableContent~en": [
                  "$.matchingRecords[*].ute~description~en"
                ],
                "ute~content~searchableContent~fr": [
                  "$.matchingRecords[*].ute~description~fr"
                ],
                "ute~content~support~nav~level1~en": "$.matchingRecords[*].ute~content~support~nav~level1~en",
                "ute~content~support~nav~level1~fr": "$.matchingRecords[*].ute~content~support~nav~level1~fr",
                "ute~content~support~typeahead~en": "$.matchingRecords[*].ute~content~support~typeahead~en",
                "ute~content~support~typeahead~fr": "$.matchingRecords[*].ute~content~support~typeahead~fr",
                "ute~content~support~seoUrl": "$.matchingRecords[*].ute~content~support~seoUrl",
                "ute~content~support~contentType~en": "$.matchingRecords[*].ute~content~support~contentType~en",
                "ute~content~support~contentType~fr": "$.matchingRecords[*].ute~content~support~contentType~fr",
                "ute~seo~pageTitle~fr": "$.matchingRecords[*].ute~seo~pageTitle~fr",
                "ute~province": "$.matchingRecords[*].ute~province"
            }
          }
        ]
      }
      }
    },
    {
     "taskCode": "RunScriptComponent-100",
     "taskClass": "RunScriptComponent",
     "taskConfigurationTemplate": {
       "params": {
         "script":
         "dataRecord['ute~content~support~seoUrl'] = !_.isEmpty(dataRecord['ute~content~support~seoUrl']) ? dataRecord['ute~content~support~seoUrl'] : _.kebabCase(dataRecord['ute~seo~pageTitle~en']);"
       }
     }
   },
    {
       "taskCode": "GetChildCount",
       "taskClass": "RunScriptComponent",
       "taskConfigurationTemplate": {
         "params": {
           "script":
           "dataRecord['childCount'] = dataRecord['childCount'].length;"
         }
       }
     },
    {
      "description": "Only keep records that have children.",
      "taskClass": "FilterDataRecord",
      "taskCode": "FilterDataRecord-ChildCount",
      "taskConfigurationTemplate": {
        "params": {
          "condition": {
            "childCount": {"$gt": 1}
          }
        }
      }
    },

    {
      "taskCode": "KeepUniqueValues",
      "taskConfigurationTemplate": {
        "params": {
          "property": [
            "ute~seo~keywords~en",
            "ute~seo~keywords~fr",
            "ute~content~searchableContent~en",
            "ute~content~searchableContent~fr"
          ]
        }
      }
    },

    {
      "taskCode": "SetPageTitleEn",
      "taskClass": "RunScriptComponent",
      "taskConfigurationTemplate": {
        "params": {
          "script":
          "dataRecord['ute~seo~pageTitle~en'] =  dataRecord['ute~seo~pageTitle~en'] ? dataRecord['ute~seo~pageTitle~en'] : 'Rogers.com';"
        }
      }
    },

    {
      "taskCode": "SetPageTitleFr",
      "taskClass": "RunScriptComponent",
      "taskConfigurationTemplate": {
        "params": {
          "script":
          "dataRecord['ute~seo~pageTitle~fr'] =  dataRecord['ute~seo~pageTitle~fr'] ? dataRecord['ute~seo~pageTitle~fr'] : 'Rogers.com';"
        }
      }
    },

    {
      "taskCode": "CopyProperties1",
      "taskClass": "CopyProperties",
      "taskConfigurationTemplate": {
        "params": {
          "copyProperties": [
            {"source":"ute~seo~pageTitle~en", "target":"ute~seo~seo_title~en"},
            {"source":"ute~seo~pageTitle~fr", "target":"ute~seo~seo_title~fr"}
          ]
        }
      }
    },

    {
      "taskCode": "CopyProperties2",
      "taskClass": "CopyProperties",
      "taskConfigurationTemplate": {
        "params": {
          "copyProperties": [
            {"source":"ute~content~support~display_from_date_hidden", "target":"ute~dateActive", "default": "647460275"},
            {"source":"ute~content~support~display_to_date_hidden", "target":"ute~dateInactive", "default": "7274426675"}
          ]
        }
      }
    },

    {
      "taskCode": "ReplacePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "pattern": "ute~content~support~isActive",
          "replacement": "ute~is_active",
          "property": "ute~content~support~isActive"
        }
      }
    },

    {
      "taskCode": "PickProperties",
      "taskConfigurationTemplate": {
        "params": {
          "properties": ["ute~*"]
        }
      }
    },
  //  {
  //    "taskCode": "Debug",
  //    "taskConfigurationTemplate": {
  //      "params": {}
  //    }
  //  }
  //  ,
    {
      "taskCode": "DataRecordToDataRepositoryBulk",
      "taskConfigurationTemplate": {
        "params": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "teamsite-aggregate-legacy-content-record"
        }
      }
    }

  ]
}