
{
  "tasks": [
    {
      "taskCode": "RemoveDataCollection",
      "taskConfigurationTemplate": {
        "in": "",
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customerCode": "{CUSTOMER_CODE}",
          "dataRepositoryCode": "{DATA_REPOSITORY_CODE}",
          "dataCollectionCode": "tv-packages-record",
          "successIfNotExists": true
        }
      }
    },
    {
      "taskCode": "CreateDataCollection",
      "taskConfigurationTemplate": {
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customerCode": "{CUSTOMER_CODE}",
          "dataRepositoryCode": "{DATA_REPOSITORY_CODE}",
          "dataCollectionCode": "tv-packages-record",
          "dataRecordIdentifierProperty": "id"
        }
      }
    },
    {
      "taskCode": "DataRepositoryToDataRecordBulk",
      "taskConfigurationTemplate": {
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customer_code": "rogers",
          "datarepo_code": "eclipse-dev",
          "datarepo_collection_code": "tv-packages-themepacks-source"}
      }
    },
    {
    "taskClass": "FilterDataRecord",
    "taskCode": "FilterDataRecord-Type",
    "taskConfigurationTemplate": {
      "params": {
        "condition": {
          "$and": [
            {"TYPE": {"$eq": "Package"}}
          ]
        }
      }
    }
  },
  {
      "taskCode": "CreateTombstoneProperties",
      "taskClass": "CreateProperties",
      "taskConfigurationTemplate": {
        "params": {
          "propertyNames": [
            "ute~recordType",
            "ute~recordClass",
            "ute~sourceSystem",
            "ute~lineOfBusiness",
            "ute~language",
            "ute~site",
            "ute~sku~channel~type"
          ],
          "propertyValues": [
            "sku",
            "package",
            ["clicc"],
            "digitalCable",
            ["EN", "FR"],
            "rogers",
            "normal"
          ]
        }
      }
    },
{
      "taskCode": "CopyProperties-1",
      "taskClass": "CopyProperties",
      "taskConfigurationTemplate": {
        "params": {
          "copyProperties": [
            {"source":"POM_SOC", "target":"ute~id"},
            {"source":"NAME_EN", "target":"ute~name~en"},
            {"source":"NAME_FR", "target":"ute~name~fr"},
            {"source":"DESCRIPTION_SHORT_EN", "target":"ute~description~en"},
            {"source":"DESCRIPTION_SHORT_FR", "target":"ute~description~fr"},
            {"source":"DESCRIPTION_LONG_EN", "target":"ute~description~long~en"},
            {"source":"DESCRIPTION_LONG_FR", "target":"ute~description~long~fr"},
            {"source":"GENRE_1_EN", "target":"ute~sku~package~genre~en"},
            {"source":"SUBGENRE_1_EN", "target":"ute~sku~package~subgenre~en"},
            {"source":"TAGS_EN", "target":"ute~sku~package~tags~en"},
            {"source":"ORDINAL", "target":"ute~sku~package~ordinal"}
          ]
        }
      }
    },


    {
      "taskCode": "DimensionLookups",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-endeca-dimensions-source",
              "baseRecordLookupPropertyName": "ute~sku~package~genre~en",
              "lookupIdPropertyNames": ["dimval~spec.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "dimval~dimension_name.raw",
                "operation": "term",
                "value": "ute.sku.package.genre.en"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~package~genre~fr": "$.matchingRecords[*].displayName~fr"
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-endeca-dimensions-source",
              "baseRecordLookupPropertyName": "ute~sku~package~subgenre~en",
              "lookupIdPropertyNames": ["dimval~spec.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "dimval~dimension_name.raw",
                "operation": "term",
                "value": "ute.sku.package.subgenre.en"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~package~subgenre~fr": "$.matchingRecords[*].displayName~fr"
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-endeca-dimensions-source",
              "baseRecordLookupPropertyName": "ute~sku~package~tags~en",
              "lookupIdPropertyNames": ["dimval~spec.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "dimval~dimension_name.raw",
                "operation": "term",
                "value": "ute.sku.package.tags.en"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~package~tags~fr": "$.matchingRecords[*].displayName~fr"
            }
          }
            ]
        }
      }
    },


    {
      "taskCode": "ExpandbySystem-1",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "unique-clicc-systems",
              "uniqueRecords": true
            },
            "enrichConfiguration": {
              "systemId": [
                "$.matchingRecords[*][SYSTEM_TABNUM]"
              ]
            }
          }
          ]
        }
      }
    },
    {
      "taskClass": "NormalizeDataRecord",
      "taskCode": "NormalizeDataRecord-System",
      "taskConfigurationTemplate": {
        "params": {
          "property": ["systemId"]
        }
      }
    },

  //    {
  //    "taskClass": "FilterDataRecord",
  //    "taskCode": "FilterDataRecord-Site",
  //    "taskConfigurationTemplate": {
  //      "params": {
  //        "condition": {
  //          "$and": [
  //             {"systemId": {"$eq": "30"} },
  //             {"POM_SOC": {"$eq": "QDP1"} }
  //           ]
  //        }
  //      }
  //    }
  //  },

    {
      "taskCode": "Pricing",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-pom-pricing-source",
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "POM_SOC_CODE.raw",
                "operation": "term",
                "value": "{{{POM_SOC}}}"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~package~price": 
                "$.matchingRecords[*].PRICE"
            }
          }
          ]
        }
      }
    },


    {
      "taskCode": "GetChannels",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "description": "Get featured channel ids",
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-channel-attributes-source",
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "POM_SOC.raw",
                "operation": "term",
                "value": "{{{POM_SOC}}}"
              }, {
                "propertyName": "SYSTEM_TABNUM.raw",
                "operation": "term",
                "value": "{{{systemId}}}"
              }, {
                "propertyName": "IS_FEATURED",
                "operation": "term",
                "value": "yes"
              }],
              "hydrateConfiguration": [
              {
              "matchConfiguration": {
                "description": "Get featured channels",
                "customerCode": "rogers",
                "dataRepositoryCode": "eclipse-dev",
                "dataCollectionCode": "tv-clicc-channels-source",
                "uniqueRecords": true,
                "lookupFilter": [{
                  "propertyName": "SERVICE_ID.raw",
                  "operation": "term",
                  "value": "{{{SERVICE_ID}}}"
                }, {
                  "propertyName": "SYSTEM_TABNUM.raw",
                  "operation": "term",
                  "value": "{{{SYSTEM_TABNUM}}}"
                }]
              },
              "enrichConfiguration": {
                "EXTERNAL_NAME_EN": ["$.matchingRecords[*].EXTERNAL_NAME_EN"],
                "EXTERNAL_NAME_FR": ["$.matchingRecords[*].EXTERNAL_NAME_FR"],
                "SERVICE_ID": ["$.matchingRecords[*].SERVICE_ID"],
                "ute~sku~package~channels": [
                  "$.matchingRecords",
                  {
                    "ute~channel~id": "SERVICE_ID",
                    "ute~name~en": "EXTERNAL_NAME_EN",
                    "ute~name~fr": "EXTERNAL_NAME_FR",
                    "ute~description~en": "CHANNEL_DESCRIPTION_EN",
                    "ute~description~fr": "CHANNEL_DESCRIPTION_FR",
                    "ute~image": "CHANNEL_LOGO",
                    "ute~sku~channel~websiteURL": "WEBSITE_URL"
                  }
                ]
              }
            }
            ]
            },
            "enrichConfiguration": {
              "ute~sku~package~featured~channels~names~en": ["$.matchingRecords[*].EXTERNAL_NAME_EN[*]"],
              "ute~sku~package~featured~channels~names~fr": ["$.matchingRecords[*].EXTERNAL_NAME_FR[*]"],   
              "ute~sku~package~featured~channels~id": ["$.matchingRecords[*].SERVICE_ID[*]"],
              "ute~sku~package~featured~channels~en": ["$.matchingRecords[*].ute~sku~package~channels[*]"],
              "ute~sku~package~featured~channels~fr": ["$.matchingRecords[*].ute~sku~package~channels[*]"],
              "ute~sku~package~featured~channels~ordinals": [
                "$.matchingRecords[*]",
                {
                  "ordinal": "ORDINAL",
                  "ute~channel~id": "SERVICE_ID[*]"
                }
              ]
            }
          },

            {
            "matchConfiguration": {
              "description": "Get bonus channel ids",
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "tv-channel-attributes-source",
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "POM_SOC.raw",
                "operation": "term",
                "value": "{{{POM_SOC}}}"
              }, {
                "propertyName": "SYSTEM_TABNUM.raw",
                "operation": "term",
                "value": "{{{systemId}}}"
              }, {
                "propertyName": "IS_FEATURED",
                "operation": "term",
                "value": "no"
              }],
              "hydrateConfiguration": [
              {
              "matchConfiguration": {
                "description": "Get bonus channels",
                "customerCode": "rogers",
                "dataRepositoryCode": "eclipse-dev",
                "dataCollectionCode": "tv-clicc-channels-source",
                "uniqueRecords": true,
                "lookupFilter": [{
                  "propertyName": "SERVICE_ID.raw",
                  "operation": "term",
                  "value": "{{{SERVICE_ID}}}"
                }, {
                  "propertyName": "SYSTEM_TABNUM.raw",
                  "operation": "term",
                  "value": "{{{SYSTEM_TABNUM}}}"
                }]
              },
              "enrichConfiguration": {
                "EXTERNAL_NAME_EN": ["$.matchingRecords[*].EXTERNAL_NAME_EN"],
                "EXTERNAL_NAME_FR": ["$.matchingRecords[*].EXTERNAL_NAME_FR"],
                "SERVICE_ID": ["$.matchingRecords[*].SERVICE_ID"],
                "ute~sku~package~channels": [
                  "$.matchingRecords",
                  {
                    "ute~channel~id": "SERVICE_ID",
                    "ute~name~en": "EXTERNAL_NAME_EN",
                    "ute~name~fr": "EXTERNAL_NAME_FR",
                    "ute~description~en": "CHANNEL_DESCRIPTION_EN",
                    "ute~description~fr": "CHANNEL_DESCRIPTION_FR",
                    "ute~image": "CHANNEL_LOGO",
                    "ute~sku~channel~websiteURL": "WEBSITE_URL"
                  }
                ]
              }
            }
            ]
            },
            "enrichConfiguration": {
              "ute~sku~package~bonus~channels~names~en": ["$.matchingRecords[*].EXTERNAL_NAME_EN[*]"],
              "ute~sku~package~bonus~channels~names~fr": ["$.matchingRecords[*].EXTERNAL_NAME_FR[*]"],   
              "ute~sku~package~bonus~channels~id": ["$.matchingRecords[*].SERVICE_ID[*]"],
              "ute~sku~package~bonus~channels~en": ["$.matchingRecords[*].ute~sku~package~channels[*]"],
              "ute~sku~package~bonus~channels~fr": ["$.matchingRecords[*].ute~sku~package~channels[*]"],
              "ute~sku~package~bonus~channels~ordinals": [
                "$.matchingRecords[*]",
                {
                  "ordinal": "ORDINAL",
                  "ute~channel~id": "SERVICE_ID[*]"
                }
              ]
            }
          }


          ]
        }
      }
    },
    {
     "taskCode": "GetId",
     "taskClass": "RunScriptComponent",
     "taskConfigurationTemplate": {
       "params": {
         "script":
         "dataRecord['id'] = _.uniqueId(dataRecord['id']);"
       }
     }
   },
  {
      "taskCode": "CopyProperties-2",
      "taskClass": "CopyProperties",
      "taskConfigurationTemplate": {
        "params": {
          "copyProperties": [
            {"source":"systemId", "target":"ute~sku~channel~channelLineup"}
          ]
        }
      }
    },
    {
      "taskClass": "KeepUniqueValues",
      "taskCode": "KeepUniqueValues",
      "taskConfigurationTemplate": {
        "params": {
          "property": ["ute~*", "ute.*"]
        }
      }
    },
    {
      "taskCode": "PickProperties",
      "taskConfigurationTemplate": {
        "params": {
          "properties": ["ute~*", "ute.*"]
        }
      }
    },
    {
     "taskCode": "ReplacePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "pattern": ".",
          "replacement": "~",
          "property": "*"
        }
      }
    },

     {
     "taskCode": "Debug",
     "taskConfigurationTemplate": {
       "params": {}
     }
   },
    {
      "taskCode": "DataRecordToDataRepositoryBulk",
      "taskConfigurationTemplate": {
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customerCode": "{CUSTOMER_CODE}",
          "dataRepositoryCode": "{DATA_REPOSITORY_CODE}",
          "dataCollectionCode": "tv-packages-record"
        }
      }
    }
  ]
}