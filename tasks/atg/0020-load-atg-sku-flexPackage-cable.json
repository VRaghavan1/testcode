{
  "tasks": [
    {
      "taskCode": "Shell-RM",
      "taskConfigurationTemplate": {
        "in": "",
        "params": {
          "options": "-f",
          "filename": "{DATA_PROCESSING_FOUNDATION}/{TEMPDIRECTORY}/{TASK_FILENAME}.xml"
        }
      }
    },
    {
      "taskCode": "DataRepositoryToDataRecordBulk",
      "taskConfigurationTemplate": {
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customer_code": "rogers",
          "datarepo_code": "eclipse-dev",
          "datarepo_collection_code": "atg-ute-pc"}
      }
    },
  {
    "taskClass": "FilterDataRecord",
    "taskCode": "FilterDataRecord-RecordType",
    "taskConfigurationTemplate": {
      "params": {
        "condition": {
          "record~type": {
            "$all": ["flexPackageSku", "cableProduct"]
          }
        }
      }
    }
  }, 
    {
      "taskCode": "inDateRange",
      "taskClass": "RunScriptComponent",
      "taskConfigurationTemplate": {
        "params": {
          "script":
          "dataRecord['inDateRange'] = _.inRange(dataRecord['ute~processingTime'], dataRecord['sku~startDate'], dataRecord['sku~endDate']);"
        }
      }
    },
    {
      "taskClass": "FilterDataRecord",
      "taskCode": "FilterDataRecord-Site",
      "taskConfigurationTemplate": {
        "params": {
          "condition": {
          "$and": [
            {"sku~siteId": {"$eq": "{SITE}"}},
            {"cableSku~saleable": {"$eq": "1"}},
            {"inDateRange": {"$eq": true}}
          ]
        }
        }
      }
    }
    ,
 {
    "taskCode": "HydrateDataRecord",
    "taskConfigurationTemplate": {
      "params": {
        "hydrate_configuration": [

            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "atg-ute-pc",
              "baseRecordLookupPropertyName": "sku~repositoryId",
              "lookupIdPropertyNames": ["sku~configurableProperties~configurationOptions~sku~repositoryId"]
            },
            "enrichConfiguration": {
              "configurableOptionOfIptvProductLineSku": [
                "$.matchingRecords[?(@['record~type'].indexOf('iptvProductLineSku')!=-1)]",
                {"name": "sku~displayName"}
            ]
            }
          },

        {
          "matchConfiguration": {
            "customerCode": "rogers",
            "dataRepositoryCode": "eclipse-dev",
            "dataCollectionCode": "atg-ute-pc",
            "baseRecordLookupPropertyName": "flexPackageSku~mandatoryFlexChannels",
            "lookupIdPropertyNames": ["sku~repositoryId"]
          },
          "enrichConfiguration": {
            "ute~sku~flexPackage~mandatoryChannelNames": [
              "$.matchingRecords[*]['sku~displayName']"
            ]
          }
        }, {
          "matchConfiguration": {
            "customerCode": "rogers",
            "dataRepositoryCode": "eclipse-dev",
            "dataCollectionCode": "atg-ute-pc",
            "baseRecordLookupPropertyName": "flexPackageSku~defaultFlexChannels",
            "lookupIdPropertyNames": ["sku~repositoryId"]
          },
          "enrichConfiguration": {
            "ute~sku~flexPackage~defaultChannelNames": [
              "$.matchingRecords[*]['sku~displayName']"
            ]
          }
        }, {
          "matchConfiguration": {
            "customerCode": "rogers",
            "dataRepositoryCode": "eclipse-dev",
            "dataCollectionCode": "atg-ute-pc",
            "baseRecordLookupPropertyName": "flexPackageSku~availableForSwapChannels",
            "lookupIdPropertyNames": ["sku~repositoryId"]
          },
          "enrichConfiguration": {
            "ute~sku~flexPackage~availableForSwapChannelNames": [
              "$.matchingRecords[*]['sku~displayName']"
            ]
          }
        },
              {
        "matchConfiguration": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "atg-ute-price",
          "baseRecordLookupPropertyName": "sku~repositoryId",
          "lookupIdPropertyNames": ["price~skuId.raw"]
        },
        "enrichConfiguration": {
          "ute~sku~flexPackage~price": [
            "$.matchingRecords[*].price~listPrice"
          ]
        }
      }

        ]
      }
    }
  }, {
    "taskCode": "CreateTombstoneProperties",
    "taskClass": "CreateProperties",
    "taskConfigurationTemplate": {
      "params": {
        "propertyNames": [
          "ute~recordType",
          "ute~recordClass",
          "ute~sourceSystem",
          "ute~lineOfBusiness",
            "ute~language"
        ],
        "propertyValues": [
          "sku",
          "flexPackage",
          "atg",
          "cable",
            ["EN","FR"]
        ]
      }
    }
  }, {
    "taskCode": "UpdateTombstoneProperties",
    "taskClass": "ChangePropertyNames",
    "taskConfigurationTemplate": {
      "params": {
        "replacePropertyNames": [{
          "source": "sku~repositoryId",
          "target": "ute~id"
        }, {
          "source": "sku~siteId",
          "target": "ute~site"
        }, {
          "source": "sku~displayName",
          "target": "ute~name~en"
        }, {
          "source": "sku~displayName_fr",
          "target": "ute~name~fr"
        }, {
          "source": "sku~description",
          "target": "ute~description~en"
        }, {
          "source": "sku~description_fr",
          "target": "ute~description~fr"
        }]
      }
    }
  }, {
    "taskCode": "UpdateRecordTypeProperties",
    "taskClass": "ChangePropertyNames",
    "taskConfigurationTemplate": {
      "params": {
        "replacePropertyNames": [{
          "source": "sku~endDate",
          "target": "ute~sku~endDate"
        }, {
          "source": "sku~startDate",
          "target": "ute~sku~startDate"
        }, {
          "source": "sku~onSale",
          "target": "ute~sku~onSale"
        }]
      }
    }
  }, {
    "taskCode": "UpdateRecordClassProperties",
    "taskClass": "ChangePropertyNames",
    "taskConfigurationTemplate": {
      "params": {
        "replacePropertyNames": [{
          "source": "cableSku~componentCode",
          "target": "ute~sku~flexPackage~ttcode"
        }]
      }
    }
  },
  {
       "taskCode": "runScriptAtgSkuFlexPackageCable",
       "taskClass": "RunScriptComponent",
       "taskConfigurationTemplate": {
         "params": {
           "script":
           "dataRecord['ute~internal~id'] =  _.snakeCase(dataRecord['ute~recordType'] + '-' + dataRecord['ute~recordClass'] + '-' + dataRecord['ute~lineOfBusiness'] + '-' + dataRecord['ute~id'])"
         }
       }
     },
  {
    "taskCode": "ReplacePropertyNames",
    "taskConfigurationTemplate": {
      "params": {
        "pattern": "~",
        "replacement": ".",
        "property": "*"
      }
    }
  },
  {
    "taskCode": "PickProperties",
    "taskConfigurationTemplate": {
      "params": {
        "properties": ["ute.*"]
      }
    }
  },
//  {
//    "taskCode": "Debug",
//    "taskConfigurationTemplate": {}
//  },
    {
      "taskCode": "DataRecordToEndecaXmlFile",
      "taskConfigurationTemplate": {
        "params": {
          "filename": "{DATA_PROCESSING_FOUNDATION}/{TEMPDIRECTORY}/{TASK_FILENAME}.xml"
        }
      }
    }
]
}
