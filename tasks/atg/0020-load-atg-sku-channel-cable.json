{
  "tasks": [
    {
      "taskCode": "Shell-RM",
      "taskConfigurationTemplate": {
        "in": "",
        "params": {
          "options": "-f",
          "filename": "{DATA_PROCESSING_FOUNDATION}/{TEMPDIRECTORY}/{TASK_FILENAME}.xml"
        }
      }
    },
    {
      "taskCode": "DataRepositoryToDataRecordBulk",
      "taskConfigurationTemplate": {
        "params": {
          "datareposervice_host": "{DATA_REPOSITORY_SERVICE_HOST}",
          "datareposervice_port": "{DATA_REPOSITORY_SERVICE_PORT}",
          "customer_code": "rogers",
          "datarepo_code": "eclipse-dev",
          "datarepo_collection_code": "atg-ute-pc"
        }
      }
    },
    {
      "taskClass": "FilterDataRecord",
      "taskCode": "FilterDataRecord-RecordType",
      "taskConfigurationTemplate": {
        "params": {
          "condition": {
            "record~type": {"$in": ["channelSku", "svodSku"]}
          }
        }
      }
    }
    ,
    {
      "taskCode": "inDateRange",
      "taskClass": "RunScriptComponent",
      "taskConfigurationTemplate": {
        "params": {
          "script":
          "dataRecord['inDateRange'] = _.inRange(dataRecord['ute~processingTime'], dataRecord['sku~startDate'], dataRecord['sku~endDate']);"
        }
      }
    },
    {
      "taskClass": "FilterDataRecord",
      "taskCode": "FilterDataRecord-Site",
      "taskConfigurationTemplate": {
        "params": {
          "condition": {
          "$and": [
            {"sku~siteId": {"$eq": "{SITE}"}},
            {"cableSku~saleable": {"$eq": "1"}},
            {"inDateRange": {"$eq": true}}
          ]
        }
        }
      }
    },
    {
      "taskCode": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "atg-ute-pc",
              "baseRecordLookupPropertyName": "sku~repositoryId",
              "lookupIdPropertyNames": ["sku~configurableProperties~configurationOptions~sku~repositoryId"]
            },
            "enrichConfiguration": {
              "configurableOptionOfIptvProductLineSku": [
                "$.matchingRecords[?(@['record~type'].indexOf('iptvProductLineSku')!=-1)]['sku~displayName']"
            ]
            }
          },
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "atg-ute-pc",
              "baseRecordLookupPropertyName": "sku~repositoryId",
              "lookupIdPropertyNames": ["sku~configurableProperties~configurationOptions~sku~repositoryId"]
            },
            "enrichConfiguration": {
              "configurableOptionOfCableOffers": [
                "$.matchingRecords[?(@['record~type'].indexOf('cableOffer')!=-1)]['sku~displayName']"
            ]
            }
          },
          {
          "matchConfiguration": {
            "customerCode": "rogers",
            "dataRepositoryCode": "eclipse-dev",
            "dataCollectionCode": "atg-ute-pc",
            "baseRecordLookupPropertyName": "sku~repositoryId",
            "lookupIdPropertyNames": ["sku~bundleLinks~item~repositoryId"]
          },
          "enrichConfiguration": {
            "ute~sku~channel~parentPackages~en": ["$.matchingRecords[?(@['record~type'].indexOf('channelPackageSku')!=-1)].sku~displayName"],
            "ute~sku~channel~parentPackages~fr": ["$.matchingRecords[?(@['record~type'].indexOf('channelPackageSku')!=-1)].sku~displayName_fr"]
          }
        },
          {
          "matchConfiguration": {
            "customerCode": "rogers",
            "dataRepositoryCode": "eclipse-dev",
            "dataCollectionCode": "atg-ute-pc",
            "baseRecordLookupPropertyName": "sku~repositoryId",
            "lookupIdPropertyNames": ["sku~bundleLinks~item~repositoryId"]
          },
          "enrichConfiguration": {
            "ute~sku~channel~themePacks~en": [
              "$.matchingRecords[?(@['record~type'].indexOf('channelPackageSku')!=-1)].sku~displayName"
            ],
            "ute~sku~channel~themePacks~fr": [
              "$.matchingRecords[?(@['record~type'].indexOf('channelPackageSku')!=-1)].sku~displayName_fr"
            ]
          }
        },

        {
        "matchConfiguration": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "featured-shows",
          "baseRecordLookupPropertyName": "cableSku~componentCode",
          "lookupIdPropertyNames": ["TTCode_P.raw"]
        },
        "enrichConfiguration": {
          "ute~sku~channel~shows": [
            "$.matchingRecords[*].ShowName_P"
          ],
          "ute~sku~channel~shows~en": [
            "$.matchingRecords[*].ShowName_P"
          ],
          "ute~sku~channel~shows~fr": [
            "$.matchingRecords[*].ShowName_P"
          ],
          "ute~sku~channel~shows~serialized": [
            "$.matchingRecords",
            {
              "ute.id": "record~spec",
              "ute.name.en": "ShowName_P",
              "ute.name.fr": "ShowName_P",
              "ute.description.en": "Show_ShortDescription_P",
              "ute.description.fr": "Show_ShortDescription_P",
              "ute.content.show.channelttcode":"TTCode_P",
              "ute.content.show.channel.province":"Province",
              "ute.content.show.channel.serviceName":"Service_Name",
              "ute.content.show.channel.callLetter":"call_letter",
              "ute.content.show.channel.expandedCallLetter":"expanded_call_letter",
              "ute.content.show.isFeatured":"Featured_Show",
              "ute.content.show.language":"Language_D",
              "ute.content.show.provider":"Provider",
              "ute.content.show.image1":"image1",
              "ute.content.show.image2":"image2",
              "ute.content.show.image3":"image3",
              "ute.content.show.image4":"image4"
            }
          ]
        }
      },

      {
        "matchConfiguration": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "iptv-clicc-data-by-component",
          "baseRecordLookupPropertyName": "cableSku~componentCode",
          "lookupIdPropertyNames": ["COMPONENT_ID.raw"]
        },
        "enrichConfiguration": {

          "ute~sku~channel~channelNumbers": [
            "$.matchingRecords",
            {
              "channel.number":"CHANNEL_NUM"
            }
          ],
          "ute.image.1": "$.matchingRecords[0].CHANNEL_LOGO",
          "ute.image.2": "$.matchingRecords[0].CHANNEL_LOGO",
          "ute.image.3": "$.matchingRecords[0].CHANNEL_LOGO",
          "ute.sku.channel.websiteUrl": "$.matchingRecords[0].WEBSITE_URL"
        }
      },

      {
        "matchConfiguration": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "atg-ute-price",
          "baseRecordLookupPropertyName": "sku~prices",
          "lookupIdPropertyNames": ["price~repositoryId.raw"]
        },
        "enrichConfiguration": {
          "ute~sku~channel~price": [
            "$.matchingRecords[*].price~listPrice"
          ]
        }
      },
      {
        "matchConfiguration": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "atg-ute-category",
          "baseRecordLookupPropertyName": "product~parentCategory~id",
          "lookupIdPropertyNames": ["dimval~spec.raw"]
        },
        "enrichConfiguration": {
          "ute~sku~channel~genre~en": "$.matchingRecords[*].dimval~display_name",
          "ute~sku~channel~genre~fr": "$.matchingRecords[*].category~displayName_fr"
        }
      }

        ]
      }
      }
    },

    {
      "taskCode": "isAlacarte",
      "taskClass": "RunScriptComponent",
      "taskConfigurationTemplate": {
        "params": {
          "script":
          "dataRecord['ute~sku~channel~alacarte'] = dataRecord['configurableOptionOfIptvProductLineSku'].length > 0 ? 'true' : 'false';"
        }
      }
    },

    {
      "taskCode": "isSVOD",
      "taskClass": "RunScriptComponent",
      "taskConfigurationTemplate": {
        "params": {
          "script":
          "dataRecord['ute~sku~channel~isSVOD'] = dataRecord['record~type'].indexOf('svodSku') != -1 ? 'true' : 'false';"
        }
      }
    },

    {
      "taskCode": "CreateTombstoneProperties",
      "taskClass": "CreateProperties",
      "taskConfigurationTemplate": {
        "params": {
          "propertyNames": [
            "ute~recordType",
            "ute~recordClass",
            "ute~sourceSystem",
            "ute~lineOfBusiness",
            "ute~language",
            "ute~province"
          ],
          "propertyValues": [
            "sku",
            "channel",
            "atg",
            "cable",
            ["EN","FR"],
            ["ON"]
          ]
        }
      }
    },
    {
      "taskCode": "UpdateTombstoneProperties",
      "taskClass": "CopyProperties",
      "taskConfigurationTemplate": {
        "params": {
          "copyProperties": [
            {"source":"sku~repositoryId", "target":"ute~id"},
            {"source":"sku~siteId", "target":"ute~site"},
            {"source":"sku~displayName", "target":"ute~name~en"},
            {"source":"sku~displayName_fr", "target":"ute~name~fr"},

            {"source":"sku~displayName", "target":"ute~sku~channel~name~en"},
            {"source":"sku~displayName_fr", "target":"ute~sku~channel~name~fr"},

            {"source":"sku~description", "target":"ute~description~en"},
            {"source":"sku~description_fr", "target":"ute~description~fr"},
            {"source":"sku~description", "target":"ute~sku~channel~shortDescription~en"},
            {"source":"sku~description_fr", "target":"ute~sku~channel~shortDescription~fr"}
          ]
        }
      }
    },
    // {
    //   "taskCode": "UpdateTombstoneProperties",
    //   "taskClass": "ChangePropertyNames",
    //   "taskConfigurationTemplate": {
    //     "params": {
    //       "replacePropertyNames": [
    //         {"source":"sku~repositoryId", "target":"ute~id"},
    //         {"source":"sku~siteId", "target":"ute~site"},
    //         {"source":"sku~displayName", "target":"ute~name~en"},
    //         {"source":"sku~displayName_fr", "target":"ute~name~fr"},

    //         {"source":"sku~displayName", "target":"ute~sku~channel~name~en"},
    //         {"source":"sku~displayName_fr", "target":"ute~sku~channel~name~fr"},

    //         {"source":"sku~description", "target":"ute~description~en"},
    //         {"source":"sku~description_fr", "target":"ute~description~fr"},
    //         {"source":"sku~description", "target":"ute~sku~channel~shortDescription~en"},
    //         {"source":"sku~description_fr", "target":"ute~sku~channel~shortDescription~fr"}
    //       ]
    //     }
    //   }
    // },
    {
      "taskCode": "UpdateRecordTypeProperties",
      "taskClass": "ChangePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "replacePropertyNames": [
            {"source":"sku~endDate", "target":"ute~sku~endDate"},
            {"source":"sku~startDate", "target":"ute~sku~startDate"},
            {"source":"sku~onSale", "target":"ute~sku~onSale"}
          ]
        }
      }
    },
    {
      "taskCode": "UpdateRecordClassProperties",
      "taskClass": "ChangePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "replacePropertyNames": [
            {"source":"cableSku~componentCode", "target":"ute~sku~channel~ttcode"},
            {"source":"channelSku~onDemand", "target":"ute~sku~channel~ondemand"},
            {"source":"cableSku~saleable", "target":"ute~sku~channel~saleable"},
            {"source":"channelSku~whereToWatch", "target":"ute~sku~channel~whereToWatch"}
          ]
        }
      }
    },
    {
       "taskCode": "runScriptAtgChannelCable",
       "taskClass": "RunScriptComponent",
       "taskConfigurationTemplate": {
         "params": {
           "script":
           "dataRecord['ute~internal~id'] =  _.snakeCase(dataRecord['ute~recordType'] + '-' + dataRecord['ute~recordClass'] + '-' + dataRecord['ute~lineOfBusiness'] + '-' + dataRecord['ute~id'])"
         }
       }
     },
     
     {
      "taskCode": "Create-dateActive-dateInactive",
      "taskClass": "CopyProperties",
      "taskConfigurationTemplate": {
        "params": {
          "copyProperties": [
            {"value":"647460275", "target":"ute~dateActive"},
            {"value":"7274426675", "target":"ute~dateInactive"}
          ]
        }
      }
    },

    {
      "taskCode": "ReplacePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "pattern": "~",
          "replacement": ".",
          "property": "*"
        }
      }
    },
    {
      "taskCode": "PickProperties",
      "taskConfigurationTemplate": {
        "params": {
          "properties": ["ute.*"]
        }
      }
    },
    {
      "taskCode": "RemoveEmptyProperties",
      "taskConfigurationTemplate": {
        "params": {
          "property": "*"
        }
      }
    },


    {
      "taskCode": "DataRecordToEndecaXmlFile",
      "taskConfigurationTemplate": {
        "params": {
          "filename": "{DATA_PROCESSING_FOUNDATION}/{TEMPDIRECTORY}/{TASK_FILENAME}.xml"
        }
      }
    }
  ]
}
