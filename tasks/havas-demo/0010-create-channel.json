{
  "tasks": [
    {
      "taskCode": "CreateDataCollection-demo-channel-record",
      "taskClass": "CreateDataCollection",
      "taskConfigurationTemplate": {
        "in": {"properties": [
            // "SYSTEM_ID.raw",
            // "SYSTEM_TABNUM.raw",
            "SERVICE_ID.raw", 
            "SERVICE_NAME_EN_EXTERNAL.raw", 
            "SERVICE_NAME_FR_EXTERNAL.raw", 
            "SERVICE_CALLSIGN.raw", 
            "CATEGORY_NAME.raw"]},

        "params": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "demo-channel-record",
          "dataRecordIdentifierProperty": "id",
          "name": "Channels Search Records",
          "successIfExists": true
        }
      }
    },
    {
      "taskCode": "TruncateDataCollection-demo-channel-record",
      "taskClass": "TruncateDataCollection",
      "taskConfigurationTemplate": {
        "params": {
          "customerCode": "rogers",
          "dataRepositoryCode": "eclipse-dev",
          "dataCollectionCode": "demo-channel-record"
        }
      }
    },
    {
      "taskCode": "UniqueDataRecordPropertiesToDataRecord",
      "taskConfigurationTemplate": {
        "in": {"properties": [
            "SERVICE_ID.raw", 
            "SERVICE_NAME_EN_EXTERNAL.raw", 
            "SERVICE_NAME_FR_EXTERNAL.raw", 
            "SERVICE_CALLSIGN.raw", 
            "CATEGORY_NAME.raw"]},
        "params": {
            "datareposervice_host": "localhost",
            "datareposervice_port": "40380",
            "customer_code": "rogers",
              "datarepo_code": "eclipse-dev",
              "datarepo_collection_code": "clicc-channels-source"
        }
      }
    },
    {
      "taskCode": "GetSystems",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "clicc-channels-source",
              "baseRecordLookupPropertyName": "SERVICE_ID",
              "lookupIdPropertyNames": ["SERVICE_ID"],
              "uniqueRecords": true
            },
            "enrichConfiguration": {
              "systemId": [
                "$.matchingRecords[*].SYSTEM_TABNUM"
              ]
            }
          }
          ]
        }
      }
    },
    

  // {
  //     "taskClass": "FilterDataRecord",
  //     "taskCode": "FilterDataRecord-Site",
  //     "taskConfigurationTemplate": {
  //       "params": {
  //         "condition": {
  //           "systemId": {"$elemMatch": "88HD"}
  //         }
  //       }
  //     }
  //   },
  //   {
  //     "taskCode": "isAlacarte2",
  //     "taskClass": "RunScriptComponent",
  //     "taskConfigurationTemplate": {
  //       "params": {
  //         "script":
  //         "dataRecord['systemId'] = '88HD';"
  //       }
  //     }
  //   },

    
    {
      "taskClass": "KeepUniqueValues",
      "taskCode": "KeepUniqueValues-System",
      "taskConfigurationTemplate": {
        "params": {
          "property": ["systemId"]
        }
      }
    },
    {
      "taskClass": "NormalizeDataRecord",
      "taskCode": "NormalizeDataRecord-System",
      "taskConfigurationTemplate": {
        "params": {
          "property": ["systemId"]
        }
      }
    },
    {
      "taskCode": "HydrateDataRecord2",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "clicc-channels-source",
              "baseRecordLookupPropertyName": "SERVICE_ID",
              "lookupIdPropertyNames": ["SERVICE_ID"],
              "uniqueRecords": true,
              "lookupFilter": {
                "propertyName": "SYSTEM_TABNUM.raw",
                "operation": "term",
                "value": "{{{systemId}}}"
              }
            },
            "enrichConfiguration": {
              "ute~sku~channel~system~names": [
                "$.matchingRecords[*].SYSTEM_NAME"
              ],
              "ute~sku~channel~channelNumbers": [
                "$.matchingRecords",
                {
                  "channel~id":"CHANNEL_ID",
                  "channel~number":"CHANNEL_NUM"
                }
              ],
              "ute~sku~channel~productCode": [
                "$.matchingRecords[*].PRODUCT_CODE"
              ],
              "ute~sku~channel~system~cities": "$.matchingRecords[*].ute~sku~channel~system~cities",
              "ute~province": "$.matchingRecords[*].ute~sku~channel~province",
              "province": "$.matchingRecords[*].ute~sku~channel~province",
              "ute~sku~channel~stb": "$.matchingRecords[*].ute~sku~channel~stb"
            }
          }
          ]
        }
      }
    },

   {
      "taskCode": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [

            {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "clicc-pom-to-clicc-source",
              "baseRecordLookupPropertyName": "SERVICE_ID",
              "lookupIdPropertyNames": ["SERVICE_ID"],
              "uniqueRecords": true
            },
            "enrichConfiguration": {
              "ute.sku.channel.pom.id": [
                "$.matchingRecords[*].POM_ID"
              ]
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "teamsite-channel-content-source",
              "baseRecordLookupPropertyName": "ute.sku.channel.pom.id",
              "lookupIdPropertyNames": ["english.product_info.product_ID.raw"],
              "uniqueRecords": true
            },
            "enrichConfiguration": {
              "ute~sku~channel~title~en": "$.matchingRecords[0].english.product_info.product_title",
              "ute~sku~channel~shortDescription~en": "$.matchingRecords[0].english.product_info.short_desc",
              "ute~image~1": "$.matchingRecords[0].english.product_images1.image_from_teamsite",
              "ute~image~2": "$.matchingRecords[0].english.product_images2.image_from_teamsite",
              "ute~image~3": "$.matchingRecords[0].english.product_images3.image_from_teamsite"
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "teamsite-channel-content-source",
              "baseRecordLookupPropertyName": "ute.sku.channel.pom.id",
              "lookupIdPropertyNames": ["french.product_info.product_ID.raw"],
              "uniqueRecords": true
            },
            "enrichConfiguration": {
              "ute~sku.channel~title~fr": "$.matchingRecords[0].french.product_info.product_title",
              "ute~sku.channel~shortDescription~fr": "$.matchingRecords[0].french.product_info.short_desc",
              "ute~image~1": "$.matchingRecords[0].french.product_images1.image_from_teamsite",
              "ute~image~2": "$.matchingRecords[0].french.product_images2.image_from_teamsite",
              "ute~image~3": "$.matchingRecords[0].french.product_images3.image_from_teamsite"
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "pom-ptv-extract-source",
              "baseRecordLookupPropertyName": "ute.sku.channel.pom.id",
              "lookupIdPropertyNames": ["CHANNELID.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "LANG.raw",
                "operation": "term",
                "value": "EN"
              },{
                "propertyName": "REGION.raw",
                "operation": "term",
                "value": "{{{province}}}"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~channel~packages": [
                "$.matchingRecords",
                {
                  "ute~package~id": "PK_SOC",
                  "ute~name~en": "PKG_NAME"
                }
              ],
              "ute~sku~channel~package~names~en": ["$.matchingRecords[*].PKG_NAME"],
              "ute~sku~channel~package~names~fr": ["$.matchingRecords[*].PKG_NAME"],
              "ute~sku~channel~genre~en": "$.matchingRecords[*].GENRE_DESC"
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "pom-ptv-extract-source",
              "baseRecordLookupPropertyName": "ute.sku.channel.pom.id",
              "lookupIdPropertyNames": ["CHANNELID.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "LANG.raw",
                "operation": "term",
                "value": "FR"
              },{
                "propertyName": "REGION.raw",
                "operation": "term",
                "value": "{{{province}}}"
              }]

            },
            "enrichConfiguration": {
              "ute~sku~channel~packages": [
                "$.matchingRecords",
                {
                  "ute~package~id": "PK_SOC",
                  "ute~name~fr": "PKG_NAME"
                }
              ],
              "ute~sku~channel~package~names~fr": ["$.matchingRecords[*].PKG_NAME"],
              "ute~sku~channel~genre~fr": "$.matchingRecords[*].GENRE_DESC"
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "pom-themepack-source",
              "baseRecordLookupPropertyName": "ute.sku.channel.pom.id",
              "lookupIdPropertyNames": ["CHANNELSLIST.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "LANG.raw",
                "operation": "term",
                "value": "EN"
              }, {
                "propertyName": "REGION.raw",
                "operation": "term",
                "value": "{{{province}}}"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~channel~themePacks": [
                "$.matchingRecords",
                {
                  "ute~themePack~id": "SOC",
                  "ute~name~en": "CMS_PRODUCT_TITLE",
                  "ute~region":"REGION"
                }
              ],
              "ute.sku.channel.themePack.names.en": ["$.matchingRecords[*].CMS_PRODUCT_TITLE"]
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "pom-themepack-source",
              "baseRecordLookupPropertyName": "ute.sku.channel.pom.id",
              "lookupIdPropertyNames": ["CHANNELSLIST.raw"],
              "uniqueRecords": true,
              "lookupFilter": [{
                "propertyName": "LANG.raw",
                "operation": "term",
                "value": "FR"
              }, {
                "propertyName": "REGION.raw",
                "operation": "term",
                "value": "{{{province}}}"
              }]
            },
            "enrichConfiguration": {
              "ute~sku~channel~themePacks": [
                "$.matchingRecords",
                {
                  "ute~name~fr": "CMS_PRODUCT_TITLE"
                }
              ],
              "ute~sku~channel~themePack~names~fr": ["$.matchingRecords[*].CMS_PRODUCT_TITLE"]
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "alacarte-channels-source",
              "baseRecordLookupPropertyName": "ute~sku~channel~productCode",
              "lookupIdPropertyNames": ["CLICC_CODE.raw"],
              "uniqueRecords": true
            },
            "enrichConfiguration": {
              "ute~sku~channel~alacarte": ["$.matchingRecords[*].CLICC_CODE"]
            }
          },
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "ptv-channel-source",
              "baseRecordLookupPropertyName": "ute~sku~channel~productCode",
              "lookupIdPropertyNames": ["CHANNELID.raw"],
              "uniqueRecords": true
            },
            "enrichConfiguration": {
              "ute~sku~channel~price": "$.matchingRecords[*].CHANNEL_PRICE"
            }
          }

        ]
      }
      }
    },
   {
      "taskCode": "GetShows",
      "taskClass": "HydrateDataRecord",
      "taskConfigurationTemplate": {
        "params": {
          "hydrate_configuration": [
          {
            "matchConfiguration": {
              "customerCode": "rogers",
              "dataRepositoryCode": "eclipse-dev",
              "dataCollectionCode": "rovi-channel-to-series",
              "baseRecordLookupPropertyName": "SERVICE_CALLSIGN",
              "lookupIdPropertyNames": ["channelCallLetter.raw"],
              "uniqueRecords": true
            },
            "enrichConfiguration": {
              "ute~sku~channel~shows~en": [
                "$.matchingRecords[*].fullTitle"
              ],
              "ute~sku~channel~shows~fr": [
                "$.matchingRecords[*].fullTitle"
              ]
            }
          }
        ]
      }
      }
    }
    ,
   // {
   //    "taskCode": "GetCast",
   //    "taskClass": "HydrateDataRecord",
   //    "taskConfigurationTemplate": {
   //      "params": {
   //        "hydrate_configuration": [
   //        {
   //          "matchConfiguration": {
   //            "customerCode": "rogers",
   //            "dataRepositoryCode": "eclipse-dev",
   //            "dataCollectionCode": "omdb",
   //            "baseRecordLookupPropertyName": "ute.sku.channel.shows.en",
   //            "lookupIdPropertyNames": ["Title"],
   //            "uniqueRecords": true,
   //            "useSearch": true
   //          },
   //          "enrichConfiguration": {
   //            "ute.sku.channel.shows.cast": [
   //              "$.matchingRecords[0].Cast"
   //            ]
   //          }
   //        }
   //      ]
   //    }
   //    }
   //  }
   //  ,
    // {
    //   "taskCode": "SplitProperty",
    //   "taskConfigurationTemplate": {
    //     "params": {
    //       "property": ["ute.sku.channel.shows.en","ute.sku.channel.shows.fr"],
    //       "separator": "\n"
    //     }
    //   }
    // },
    {
      "taskCode": "SplitGenreEnglish",
      "taskClass": "RunScriptComponent",
      "taskConfigurationTemplate": {
        "params": {
          "script":
          "if (dataRecord['ute.sku.channel.genre.en']) { dataRecord['ute.sku.channel.subgenre.en'] = dataRecord['ute.sku.channel.genre.en'].split('/')[1]; dataRecord['ute.sku.channel.genre.en'] = dataRecord['ute.sku.channel.genre.en'].split('/')[0]; } "
        }
      }
    },
    {
      "taskCode": "SplitGenreFrench",
      "taskClass": "RunScriptComponent",
      "taskConfigurationTemplate": {
        "params": {
          "script":
          "if (dataRecord['ute.sku.channel.genre.fr']) {dataRecord['ute.sku.channel.subgenre.fr'] =  dataRecord['ute.sku.channel.genre.fr'].split('/')[1]; dataRecord['ute.sku.channel.genre.fr'] = dataRecord['ute.sku.channel.genre.fr'].split('/')[0]; } ''"
        }
      }
    },
    {
      "taskCode": "KeepUniqueValues-",
      "taskClass": "KeepUniqueValues",
      "taskConfigurationTemplate": {
        "params": {
          "property": [
            "ute~sku~channel~system~ids",
            "ute~sku~channel~channelNumbers",
            "ute.*",
            "ute~*"
          ]
        }
      }
    },
    {
      "taskCode": "CreateTombstoneProperties",
      "taskClass": "CreateProperties",
      "taskConfigurationTemplate": {
        "params": {
          "propertyNames": [
            "ute~recordType",
            "ute~recordClass",
            "ute~sourceSystem",
            "ute~lineOfBusiness",
            "ute~language",
            "ute~site",
            "ute~sku~channel~ondemand"
          ],
          "propertyValues": [
            "sku",
            "channel",
            ["clicc", "teamsite", "pom"],
            "digitalCable",
            ["EN", "FR"],
            "rogers",
            "0"
          ]
        }
      }
    },
    {
      "taskCode": "UpdateTombstoneProperties",
      "taskClass": "ChangePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "replacePropertyNames": [
            {"source":"SERVICE_ID", "target":"ute~id"},
            {"source":"SERVICE_NAME_EN_EXTERNAL", "target":"ute~name"},
            {"source":"SERVICE_NAME_FR_EXTERNAL", "target":"ute~name~fr"},
            {"source":"systemId", "target":"ute~sku~channel~system~id"}
          ]
        }
      }
    },
    {
      "taskCode": "UpdateRecordClassProperties",
      "taskClass": "ChangePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "replacePropertyNames": [
            {"source":"SERVICE_CALLSIGN", "target":"ute~sku~channel~callsign"},
            {"source":"CATEGORY_NAME", "target":"ute~sku~channel~category"}
          ]
        }
      }
    },
    {
     "taskCode": "runscriptSkuDigitalCable",
     "taskClass": "RunScriptComponent",
     "taskConfigurationTemplate": {
       "params": {
         "script":
         "dataRecord['ute~internal~id'] =  _.snakeCase(dataRecord['ute~recordType'] + '-' + dataRecord['ute~recordClass'] + '-' + dataRecord['ute~lineOfBusiness'] + '-' + dataRecord['ute~id'] + '-' + dataRecord['ute~province'] + '-'+dataRecord['ute~sku~channel~category']+'-'+dataRecord['ute~sku~channel~callsign'] + '-' + dataRecord['ute~sku~channel~system~id'])"
       }
     }
   },
    {
      "taskCode": "ReplacePropertyNames",
      "taskConfigurationTemplate": {
        "params": {
          "pattern": ".",
          "replacement": "~",
          "property": "*"
        }
      }
    },
     {
       "taskCode": "DataRecordToJsonFile",
       "taskConfigurationTemplate": {
         "params": {
           "filename": "{DATA_PROCESSING_FOUNDATION}/temp/{TASK_FILENAME}.jsonl"
         }
       }
     }
    // {
    //   "taskCode": "DataRecordToDataRepositoryBulk",
    //   "taskConfigurationTemplate": {
    //     "params": {
    //       "customerCode": "rogers",
    //       "dataRepositoryCode": "eclipse-dev",
    //       "dataCollectionCode": "demo-channel-record"
    //     }
    //   }
    // }
  ]
}
